{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "wf.schema.json",
  "title": "Workflow Definition Schema",
  "description": "Validates wf.yaml workflow definition files. Stages are self-contained.",
  "type": "object",
  "required": ["version", "metadata", "stages"],
  "definitions": {
    "input_item": {
      "type": "object",
      "required": ["name", "path"],
      "properties": {
        "name": {"type": "string", "description": "Input file name"},
        "path": {"type": "string", "pattern": "^inputs/", "description": "Path in inputs/"},
        "description": {"type": "string"},
        "from_stage": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9-]*$",
          "description": "Source stage ID (if input comes from another stage)"
        },
        "source": {
          "type": "string",
          "pattern": "^run/(output-files|output-data)/",
          "description": "Path in source stage (required if from_stage set)"
        }
      }
    },
    "output_item": {
      "type": "object",
      "required": ["name", "path"],
      "properties": {
        "name": {"type": "string"},
        "path": {"type": "string"},
        "description": {"type": "string"},
        "schema": {"type": "string", "description": "Path to JSON Schema file"},
        "required": {"type": "boolean", "default": true}
      }
    },
    "parameter_item": {
      "type": "object",
      "required": ["name", "from_stage"],
      "description": "Reference a value from a prior stage - either via output_parameter name or direct query",
      "properties": {
        "name": {"type": "string", "description": "Parameter name (available to this stage)"},
        "description": {"type": "string"},
        "from_stage": {"type": "string", "pattern": "^[a-z][a-z0-9-]*$"},
        "output_parameter": {
          "type": "string",
          "description": "Name of published output_parameter from source stage (preferred)"
        },
        "source": {
          "type": "string",
          "pattern": "^run/output-data/.*\\.json$",
          "description": "Direct path to JSON file (use with query, alternative to output_parameter)"
        },
        "query": {
          "type": "string",
          "description": "JSONPath-style query when using source (e.g., 'summary.total')"
        }
      },
      "oneOf": [
        {"required": ["output_parameter"]},
        {"required": ["source", "query"]}
      ]
    },
    "output_parameter_item": {
      "type": "object",
      "required": ["name", "source", "query"],
      "description": "Declare a value this stage publishes for downstream consumption",
      "properties": {
        "name": {"type": "string", "description": "Published parameter name"},
        "description": {"type": "string", "description": "What this parameter represents"},
        "source": {
          "type": "string",
          "pattern": "^run/output-data/.*\\.json$",
          "description": "JSON file containing the value"
        },
        "query": {
          "type": "string",
          "description": "JSONPath-style query to extract the value"
        }
      }
    }
  },
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+$"
    },
    "metadata": {
      "type": "object",
      "required": ["name", "description"],
      "properties": {
        "name": {"type": "string", "pattern": "^[a-z][a-z0-9-]*$"},
        "description": {"type": "string", "minLength": 10},
        "author": {"type": "string"}
      }
    },
    "stages": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id", "name", "inputs", "outputs", "prompt"],
        "properties": {
          "id": {"type": "string", "pattern": "^[a-z][a-z0-9-]*$"},
          "name": {"type": "string"},
          "description": {"type": "string"},
          "inputs": {
            "type": "object",
            "properties": {
              "required": {"type": "array", "items": {"$ref": "#/definitions/input_item"}},
              "optional": {"type": "array", "items": {"$ref": "#/definitions/input_item"}}
            }
          },
          "parameters": {
            "type": "array",
            "description": "Values from prior stages (via output_parameter name or direct query)",
            "items": {"$ref": "#/definitions/parameter_item"}
          },
          "output_parameters": {
            "type": "array",
            "description": "Values this stage publishes for downstream consumption",
            "items": {"$ref": "#/definitions/output_parameter_item"}
          },
          "outputs": {
            "type": "object",
            "properties": {
              "files": {"type": "array", "items": {"$ref": "#/definitions/output_item"}},
              "data": {"type": "array", "items": {"$ref": "#/definitions/output_item"}}
            }
          },
          "prompt": {
            "type": "object",
            "required": ["entry", "main"],
            "properties": {
              "entry": {"type": "string"},
              "main": {"type": "string"}
            }
          }
        }
      }
    },
    "shared_templates": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["source", "target"],
        "properties": {
          "source": {"type": "string"},
          "target": {"type": "string"}
        }
      }
    }
  }
}
